name: Build Mac App

on:
  workflow_dispatch:   # Manual trigger from GitHub Actions tab

jobs:
  build-mac:
    runs-on: macos-latest   # GitHub provides a real Mac machine for free

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install \
            "PyQt6>=6.5.0" \
            "Pillow>=10.0.0" \
            "psutil>=5.9.0" \
            "pyobjc-core>=9.0" \
            "pyobjc-framework-Cocoa>=9.0" \
            "PyInstaller>=6.0.0"

      - name: Convert icon to .icns for Mac
        run: |
          mkdir icon.iconset
          python3 - <<'EOF'
          from PIL import Image
          img = Image.open("assets/icon.ico").convert("RGBA")
          sizes = [16,32,64,128,256,512,1024]
          for s in sizes:
              img.resize((s,s), Image.LANCZOS).save(f"icon.iconset/icon_{s}x{s}.png")
              if s <= 512:
                  img.resize((s*2,s*2), Image.LANCZOS).save(f"icon.iconset/icon_{s}x{s}@2x.png")
          EOF
          iconutil -c icns icon.iconset -o assets/icon.icns

      - name: Build .app with PyInstaller
        run: |
          pyinstaller desktop_pet.spec

      - name: Zip the .app for download
        run: |
          cd dist
          zip -r DesktopPet-mac.zip DesktopPet.app

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: DesktopPet-mac
          path: dist/DesktopPet-mac.zip
          retention-days: 30   # Download available for 30 days
